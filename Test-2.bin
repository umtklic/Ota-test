

#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
//----------------------------------------Include the Servo Library
#include "PageIndex.h"; //--> Include the contents of the User Interface Web page, stored in the same folder as the .ino file
#define LEDonBoard 2  //--> Defining an On Board LED, used for indicators when the process of connecting to a wifi router
#define LEDpin D1   //--> Defining Servo Port
int value=0;
int valuess;
int val;
int encoder0PinA = D2;
int encoder0PinB = D3;
int button =D4;
int ledstatus = HIGH;
int encoder0Pos = 0;
int encoder0PinALast = LOW;
int n = LOW;
int i=0;
int lastvalue=0;
//----------------------------------------SSID and Password of your WiFi router
const char *ssid = "KLC_Wifi";
const char *password = "72467246";
//----------------------------------------
 ESP8266WebServer server(80);  //--> Server on port 80
//----------------------------------------This routine is executed when you open NodeMCU ESP8266 IP Address in browser
void handleRoot() {
 String s = MAIN_page; //Read HTML contents
 server.send(200, "text/html", s); //Send web page
}
//----------------------------------------

//----------------------------------------Procedure for handling servo control
void handleServo(){
  String POS = server.arg("servoPOS");
  int pos = POS.toInt();
  value=map(pos,0,180,0,1024);
  analogWrite(LEDpin,value);
  lastvalue=value;
  ledstatus = HIGH;
  delay(15);
  Serial.print("value:");
  Serial.println(value);
  server.send(200, "text/plane","");
  }

//---------------------------------------------------------------SETUP------------------------------------------------------------------------
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  WiFi.begin(ssid, password); 
  Serial.println("");
    
  pinMode(LEDonBoard,OUTPUT); 
  digitalWrite(LEDonBoard, HIGH); 
  pinMode(LEDpin,OUTPUT);
  pinMode (encoder0PinA, INPUT);
  pinMode (encoder0PinB, INPUT);
  pinMode (button, INPUT);

  Serial.print("Connecting");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    //---------------------------------------
    digitalWrite(LEDonBoard, LOW);
    delay(250);
    digitalWrite(LEDonBoard, HIGH);
    delay(250);
    //--------------------------------------
  }
  //----------------------------------------
  digitalWrite(LEDonBoard, HIGH); //--> Turn off the On Board LED when it is connected to the wifi router.
  //----------------------------------------If connection successful show IP address in serial monitor
  Serial.println("");
  Serial.print("Successfully connected to : ");
  Serial.println(ssid);
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());
  //----------------------------------------

  //----------------------------------------Initialize Webserver
  server.on("/",handleRoot);  //--> Routine to handle at root location. This is to display web page.
  server.on("/setPOS",handleServo); //--> Sets servo position from Web request
  server.begin();  
  Serial.println("HTTP server started");
}

//---------------------------------------------------------------Loop----------------------------------------
void loop() {
 server.handleClient();
 n = digitalRead(encoder0PinA);
  if ((encoder0PinALast == LOW) && (n == HIGH) && (ledstatus==HIGH)) {    
    if (digitalRead(encoder0PinB) == LOW) {      
      value=value-value*0.1-1;
      for(i=lastvalue; value<=i;i--){
        analogWrite(LEDpin,i);
        lastvalue=i;
        delay(0.1);    
        
      }
    } else {      
      value=value+value*0.2+1;
      for(i=lastvalue; value>=i;i++){
        analogWrite(LEDpin,i);
        delay(0.1);        
        lastvalue=i;
        
      }
    }
    if(value>1024){
      value=1024;
    }
    if(value<0){
      value=0;
    }
     //analogWrite(LEDpin,value);
     Serial.print(i);
     Serial.print("\t");
     Serial.println(value);
    
  }
  encoder0PinALast = n;

if (digitalRead(button) == LOW) {
ledstatus = !ledstatus;

 while(digitalRead(button) == LOW);
delay(50); // keeps a small delay
if(ledstatus==LOW){
   for(i=lastvalue; 0<=i;i--){
        analogWrite(LEDpin,i);
        delay(1);
   }
}else{

     for(i=0; lastvalue>=i;i++){
        analogWrite(LEDpin,i);
        delay(1);}}}}
        
  



  
 
 

//------------------------------------------------------------------------------------
